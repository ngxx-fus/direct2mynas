<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>NAS REDIRECT (CHUYỂN TIẾP ĐẾN NAS CỦA FUS)</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyANRc0UBr3t9rAz6LRjuatZKlGGk7dTG4Y",
      authDomain: "my-nas-ip.firebaseapp.com",
      databaseURL: "https://my-nas-ip-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "my-nas-ip",
      storageBucket: "my-nas-ip.firebasestorage.app",
      messagingSenderId: "306142893095",
      appId: "1:306142893095:web:ce7577eeb0ec2953162a02"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    let autoRedirectInterval; /// @brief Global timer reference for the countdown.
    let targetButton = null;  /// @brief Reference to the auto-redirect button.
    let targetButtonName = ""; /// @brief Original text of the auto-redirect button.

    /// @brief Uses an image-loading trick to check if the server is responding.
    function checkServerStatus(url) {
      return new Promise((resolve) => {
        const img = new Image();
        const timer = setTimeout(() => {
          img.src = ""; 
          resolve(false); 
        }, 3500);

        img.onload = () => {
          clearTimeout(timer);
          resolve(true); 
        };

        img.onerror = () => {
          clearTimeout(timer);
          resolve(true); 
        };

        img.src = url + "/favicon.ico?t=" + new Date().getTime(); 
      });
    }

    /// @brief Stops the auto-redirect and restores the button text.
    function stopAutoRedirect() {
      if (autoRedirectInterval) {
        clearInterval(autoRedirectInterval);
        autoRedirectInterval = null;
        if (targetButton) {
          const textSpan = targetButton.querySelector(".btn-text");
          textSpan.innerText = targetButtonName;
        }
      }
    }

    /// @brief Starts the 15s countdown directly on the button label.
    /// @param btn The button element to update.
    /// @param url The destination URL.
    function startCountdown(btn, url) {
      let secondsLeft = 10;
      targetButton = btn;
      const textSpan = btn.querySelector(".btn-text");
      targetButtonName = textSpan.innerText;

      autoRedirectInterval = setInterval(() => {
        secondsLeft--;
        textSpan.innerText = `${targetButtonName} (${secondsLeft}s)`;
        
        if (secondsLeft <= 0) {
          clearInterval(autoRedirectInterval);
          window.location.href = url;
        }
      }, 1000);
    }

    /// @brief Fetches NAS IP and Port info from Firebase and builds the UI.
    async function loadData() {
      try {
        const snapshot = await get(ref(db));
        if (snapshot.exists()) {
          const data = snapshot.val();

          const infoBox = document.getElementById("info-box");
          infoBox.innerHTML = "<h2>Firebase RTDB data:</h2><pre>" + JSON.stringify(data, null, 2) + "</pre>";

          const buttons = document.getElementById("buttons");
          buttons.innerHTML = ""; 

          const services = [
            {
              name: "File Browser (Login required)",
              color: "#3259CD",
              url: `http://${data.GlobalIp}:${data.FileBrowsePort}`
            },
            {
              name: "OpenMediaVault (Login required)",
              color: "#00809D",
              url: `https://${data.GlobalIp}:${data.OMVPort}`
            },
            {
              name: "Shared folder",
              color: "#17313E",
              url: `http://${data.GlobalIp}:${data.FileBrowsePort}/share/f7vgQCfs`
            }
          ];

          services.forEach((service, index) => {
            if (data.GlobalIp) {
              const btn = createButton(service.name, service.color, service.url);
              buttons.appendChild(btn);
              
              /// Start countdown on the first button (File Browser)
              if (index === 0) {
                startCountdown(btn, service.url);
              }
            }
          });

        } else {
          document.getElementById("info-box").innerText = "No record found!";
        }
      } catch (err) {
        console.error(err);
        document.getElementById("info-box").innerText = "Error while reading from Firebase!";
      }
    }

    /// @brief Creates a styled button with a built-in availability check.
    function createButton(text, color, link) {
      const btn = document.createElement("button");
      btn.innerHTML = `<span class="square"></span><span class="btn-text">${text}</span>`;
      btn.style.backgroundColor = color;
      
      btn.onclick = async () => {
        stopAutoRedirect(); /// Cancel countdown if any interaction occurs.

        const originalContent = btn.innerHTML;
        btn.style.opacity = "0.5";
        btn.innerText = "Checking status...";
        
        const isOnline = await checkServerStatus(link);
        
        if (isOnline) {
          window.location.href = link;
        } else {
          alert("❌ SERVER OFFLINE!\nPlease check the NAS power or network.");
          btn.style.opacity = "1";
          btn.innerHTML = originalContent;
        }
      };
      return btn;
    }

    loadData();
  </script>
  <style>
    body { background-color: black; color: white; font-family: monospace; padding: 20px; text-align: center; }
    #data { border: 2px solid white; padding: 20px; margin: 0 auto 20px auto; width: 600px; border-radius: 10px; background: #111; display: flex; flex-direction: column; align-items: center; }
    #info-box { background: transparent; padding: 10px; width: 90%; text-align: left; margin-bottom: 20px; }
    #buttons { width: 90%; display: flex; flex-direction: column; gap: 10px; }
    button { display: flex; align-items: center; padding: 12px 15px; font-size: 16px; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; text-align: left; transition: 0.3s; }
    .square { width: 15px; height: 15px; background-color: white; display: inline-block; margin-right: 10px; border-radius: 2px; flex-shrink: 0; }
    .btn-text { flex: 1; text-align: left; font-weight: bold; }
    button:hover { opacity: 0.85; transform: scale(1.02); }
    footer { margin-top: 30px; font-size: 14px; color: #aaa; line-height: 1.6; }
  </style>
</head>

<body>
  <div id="data">
    <div id="info-box">Loading... (Đang tải...)</div>
    <div id="buttons"></div>
  </div>
  <footer>
    Nguyễn Thanh Phú - 0845939722 - msnp@outlook.com.vn
    <br>
    <details>
      <summary>note ._.</summary>
      <p>Sometimes, the service is not available due to a <b>power failure</b>.</p>
      File Browser Username/Password: guest / guest
    </details>
  </footer>
</body>

</html>
